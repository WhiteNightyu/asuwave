# 通信协议

## 示意图

```
+-------------+ Serial +-------------+  TCP   +-------------+
|     MCU     |------->|   Server    |------->|   Client    |
|             |<-------|   Backend   |<-------|   Frontend  |
+-------------+        +-------------+        +-------------+
```

## 串口

### 数据包结构

#### 单片机接收
| 字节下标号 | 描述 |
| -------- | ---- |
|   0      | [单片机代号](#单片机代号) |
|   1      | [请求代号](#请求代号) |
|   2      | 数据长度 |
|   3-6    | 单片机地址 |
|   7-14   | 数据 |
|   15     | 尾部固定为0x0a |

#### 单片机发送
| 字节下标号 | 描述 |
| -------- | ---- |
|   0      | [单片机代号](#单片机代号) |
|   1      | [响应或错误代号](#响应或错误代号) |
|   2      | 数据长度 |
|   3-6    | 单片机地址 |
|   7-14   | 数据 |
|   15-18  | 时间戳 |
|   19     | 尾部固定为0x0a |

### 单片机代号
为以后扩展保留，目前只取值为`0x01`  

### 请求代号
|  值   | 描述 |
| ---- | ---- |
| 0x01 | 订阅位于给定单片机地址和数据长度的值，此后单片机会一直发送位于该地址的变量值 |
| 0x03 | 取消订阅位于给定单片机地址和数据长度的值 |
| 0x05 | 读取位于给定单片机地址和数据长度的值 |
| 0x07 | 修改位于给定单片机地址和数据长度的值 |

### 响应或错误代号
|  值   | 描述 |
| ---- | ---- |
| 0x02 | 订阅的正常返回 |
| 0x04 | 取消订阅的正常返回 |
| 0x06 | 读取的正常返回 |
| 0x08 | 修改的正常返回 |
| 0xf9 | 取消订阅未订阅的地址 |
| 0xfa | 订阅变量已达上限 |
| 0xfb | 不支持的数据长度 |
| 0xfc | 不支持的地址 |
| 0xfd | 不支持的请求代号 |
| 0xfe | 不支持的单片机代号 |
